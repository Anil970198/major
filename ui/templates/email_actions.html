<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Actions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
</head>

<body class="bg-gradient-to-r from-blue-100 via-white to-blue-100 min-h-screen p-6 flex justify-center">

  <div class="bg-white shadow-lg rounded-xl w-full max-w-3xl p-8">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for category, message in messages %}
            <div class="p-4 text-sm rounded border
              {% if category == 'success' %}
                bg-green-100 text-green-800 border-green-300
              {% elif category == 'danger' %}
                bg-red-100 text-red-800 border-red-300
              {% elif category == 'warning' %}
                bg-yellow-100 text-yellow-800 border-yellow-300
              {% else %}
                bg-gray-100 text-gray-800 border-gray-300
              {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- From -->
    <p class="mb-2"><strong>From:</strong> {{ email.from_addr or "Unknown" }}</p>

    <!-- Snippet -->
    <p class="font-semibold mt-4 mb-2">Email Snippet:</p>
    <div class="markdown-body bg-gray-100 p-4 rounded text-sm border border-gray-300 mb-6">
      {{ email.snippet | markdown }}
    </div>

    <!-- Draft Reply -->
    <p class="font-semibold mb-2">Draft Reply:</p>
    <form action="{{ url_for('send_reply_action', email_id=email.id) }}" method="post">
      <textarea name="final_draft" rows="12" class="w-full border rounded p-4 mb-4 text-sm">{{ email.draft_reply or "" }}</textarea>

      <!-- Tone Explanation -->
      <div class="bg-gray-50 border border-gray-300 p-4 rounded mb-4 text-sm text-gray-800">
        <strong>Explanation of tone changes:</strong>
        <ul class="list-disc pl-6 mt-2 space-y-1">
          <li>Started with a casual greeting and warm tone.</li>
          <li>Used conversational phrases to maintain approachability.</li>
          <li>Rephrased support lines to sound more helpful and empathetic.</li>
          <li>Closed with friendly language and call-to-action.</li>
        </ul>
      </div>

      <!-- Tone Selector -->
      <div class="mb-6 flex items-center gap-2">
        <label for="tone" class="font-medium">Select Tone:</label>
        <select name="tone" id="tone" class="border rounded p-2">
          <option value="formal">Formal</option>
          <option value="casual">Casual</option>
          <option value="assertive">Assertive</option>
          <option value="friendly">Friendly</option>
          <option value="apologetic">Apologetic</option>
        </select>
      </div>

      <!-- Buttons -->
      <div class="flex flex-wrap justify-center gap-4">
        <button type="submit" formaction="{{ url_for('rewrite_draft_action', email_id=email.id) }}"
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded"
                onclick="document.getElementById('hiddenTone').value = document.getElementById('tone').value">
          ✍️ Rewrite Draft
        </button>

        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
          📤 Send Reply
        </button>

        <a href="{{ url_for('emails') }}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
          🏠 Back to Emails
        </a>
      </div>

      <input type="hidden" name="tone" id="hiddenTone" value="formal">
    </form>

    <!-- Meeting Scheduler -->
    <hr class="my-8 border-gray-300" />
    <h2 class="text-lg font-semibold mb-4">📅 Schedule a Meeting</h2>

    <form method="POST" action="{{ url_for('schedule_meeting', email_id=email.id) }}" class="space-y-4">
      <div>
        <label class="block font-medium mb-1">Recipient Email:</label>
        <input type="email" name="recipient" value="{{ email.from_addr }}" class="w-full border p-2 rounded" required />
      </div>

      <div>
        <label class="block font-medium mb-1">Date:</label>
        <input type="date" name="date" class="w-full border p-2 rounded" required />
      </div>

      <div>
        <label class="block font-medium mb-1">Start Time:</label>
        <input type="time" name="start_time" class="w-full border p-2 rounded" required />
      </div>

      <div>
        <label class="block font-medium mb-1">End Time:</label>
        <input type="time" name="end_time" class="w-full border p-2 rounded" required />
      </div>

      <input type="hidden" name="title" value="Meeting with Anil" />

      <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
        📨 Send Calendar Invite
      </button>
    </form>
  </div>

  <!-- Tone Sync Script -->
  <script>
    const toneSelect = document.getElementById('tone');
    const hiddenTone = document.getElementById('hiddenTone');
    toneSelect?.addEventListener('change', () => {
      if (hiddenTone) hiddenTone.value = toneSelect.value;
    });
    if (hiddenTone) hiddenTone.value = toneSelect?.value;
  </script>
</body>
</html>
